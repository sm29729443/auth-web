import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule, FormBuilder, FormGroup, Validators } from '@angular/forms';
import { Router, ActivatedRoute } from '@angular/router';
import { Subject, takeUntil } from 'rxjs';
import { MatDialog } from '@angular/material/dialog';

import { RegisterService } from '../../services/register.service';
import { RegisterFormData, OtpVerifyData } from '../../models/register.model';
import { CustomValidators } from '../../validators/custom-validators';
import { PhoneConfirmDialogComponent } from '../../components/phone-confirm-dialog/phone-confirm-dialog.component';
import { TokenService } from '../../services/token.service';

/**
 * è¨»å†Šä¸»çµ„ä»¶ - åŒ…å«å…©å€‹æ­¥é©Ÿï¼šåŸºæœ¬è³‡æ–™è¼¸å…¥å’Œ OTP é©—è­‰
 * ä½¿ç”¨ Angular 19 æ–°èªæ³•
 */
@Component({
  selector: 'app-register',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './register.component.html',
  styleUrl: './register.component.css'
})
export class RegisterComponent implements OnInit, OnDestroy {

  /** ç›®å‰æ­¥é©Ÿ (1: åŸºæœ¬è³‡æ–™, 2: OTPé©—è­‰) */
  currentStep: number = 1;

  /** åŸºæœ¬è³‡æ–™è¡¨å–® */
  registerForm!: FormGroup;

  /** OTP é©—è­‰è¡¨å–® */
  otpForm!: FormGroup;

  /** è¼‰å…¥ç‹€æ…‹ */
  isLoading = false;

  /** éŒ¯èª¤è¨Šæ¯ */
  errorMessage = '';

  /** æˆåŠŸè¨Šæ¯ */
  successMessage = '';

  /** OTP å€’æ•¸è¨ˆæ™‚ */
  otpCountdown = 1;

  /** å€’æ•¸è¨ˆæ™‚å™¨ */
  private countdownTimer?: number;

  /** æ˜¯å¦å¯ä»¥é‡æ–°ç™¼é€ OTP */
  canResendOtp = false;

  /** æ˜¯å¦å·²å˜—è©¦æäº¤è¡¨å–® */
  isFormSubmitted = false;

  /** å¹´ä»½é¸é … */
  years: string[] = [];

  /** æœˆä»½é¸é … */
  months: string[] = [];

  /** æ—¥æœŸé¸é … */
  days: string[] = [];

  /** ç¸£å¸‚è¼‰å…¥ç‹€æ…‹ */
  isLoadingCities = false;

  /** å€åŸŸè¼‰å…¥ç‹€æ…‹ */
  isLoadingDistricts = false;

  /** ç¸£å¸‚é¸é … */
  cities = [
    'å°åŒ—å¸‚', 'æ–°åŒ—å¸‚', 'æ¡ƒåœ’å¸‚', 'å°ä¸­å¸‚', 'å°å—å¸‚', 'é«˜é›„å¸‚',
    'æ–°ç«¹ç¸£', 'è‹—æ —ç¸£', 'å½°åŒ–ç¸£', 'å—æŠ•ç¸£', 'é›²æ—ç¸£', 'å˜‰ç¾©ç¸£',
    'å±æ±ç¸£', 'å®œè˜­ç¸£', 'èŠ±è“®ç¸£', 'å°æ±ç¸£', 'æ¾æ¹–ç¸£', 'é‡‘é–€ç¸£', 'é€£æ±Ÿç¸£',
    'åŸºéš†å¸‚', 'æ–°ç«¹å¸‚', 'å˜‰ç¾©å¸‚'
  ];

  /** å€åŸŸé¸é … - æ”¹ç‚ºå‹•æ…‹è¼‰å…¥ */
  currentDistricts: string[] = [];

  /** éŠ·æ¯€è¨‚é–± */
  private destroy$ = new Subject<void>();

  constructor(
    private fb: FormBuilder,
    private registerService: RegisterService,
    public router: Router,
    private route: ActivatedRoute,
    private dialog: MatDialog,
    private tokenService: TokenService
  ) {
    this.initializeDateOptions();
  }

  ngOnInit(): void {
    this.initializeForms();
    this.loadCities();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ tokenï¼ˆmain.ts å·²ç¶“è™•ç†äº† URL æå–ï¼‰
    this.checkTokenAvailability();
  }

  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
    this.clearCountdownTimer();
  }

  /**
   * åˆå§‹åŒ–è¡¨å–®
   */
  private initializeForms(): void {
    // åŸºæœ¬è³‡æ–™è¡¨å–®
    this.registerForm = this.fb.group({
      idNumber: ['', [
        Validators.required,
        CustomValidators.taiwanId()
      ]],
      name: ['', [
        Validators.required,
        Validators.minLength(2),
        Validators.maxLength(20)
      ]],
      birthDate: this.fb.group({
        year: ['', Validators.required],
        month: ['', Validators.required],
        day: ['', Validators.required]
      }, { validators: CustomValidators.minimumAge(18) }),
      address: this.fb.group({
        city: ['', Validators.required], // æ”¹ç‚º null è€Œä¸æ˜¯ç©ºå­—ä¸²
        district: ['', Validators.required],
        detail: ['', [
          Validators.required,
          Validators.minLength(2),
          Validators.maxLength(20)
        ]]
      }),
      phoneNumber: ['', [
        Validators.required,
        CustomValidators.taiwanPhone()
      ]],
      email: ['', [
        Validators.required,
        Validators.email
      ]]
    });

    // OTP é©—è­‰è¡¨å–®
    this.otpForm = this.fb.group({
      otpCode: ['', [
        Validators.required,
        CustomValidators.otpCode(6)
      ]]
    });
  }

  /**
   * åˆå§‹åŒ–æ—¥æœŸé¸é …
   */
  private initializeDateOptions(): void {
    const currentYear = new Date().getFullYear();

    // ç”Ÿæˆå¹´ä»½é¸é … (ç›®å‰å¹´ä»½å¾€å‰100å¹´)
    for (let year = currentYear; year >= currentYear - 100; year--) {
      this.years.push(year.toString());
    }

    // ç”Ÿæˆæœˆä»½é¸é …
    for (let month = 1; month <= 12; month++) {
      this.months.push(month.toString().padStart(2, '0'));
    }

    // ç”Ÿæˆæ—¥æœŸé¸é … (é è¨­31å¤©ï¼Œå¾ŒçºŒæ ¹æ“šå¹´æœˆå‹•æ…‹èª¿æ•´)
    for (let day = 1; day <= 31; day++) {
      this.days.push(day.toString().padStart(2, '0'));
    }
  }

  /**
   * æª¢æŸ¥ token å¯ç”¨æ€§ï¼ˆtoken å·²ç”± main.ts è™•ç†ï¼‰
   */
  private checkTokenAvailability(): void {
    const hasToken = this.tokenService.hasToken();
    
    if (hasToken) {
      console.log('âœ… Token available in RegisterComponent');
      
      // å¯é¸ï¼šé©—è­‰ scope æ˜¯å¦ç‚º AUTHï¼ˆæ ¹æ“šæ‚¨çš„æ¥­å‹™é‚è¼¯ï¼‰
      if (this.tokenService.isValidAuthScope()) {
        console.log('âœ… Token scope is valid for AUTH');
      } else {
        console.warn('âš ï¸ Token scope is not AUTH');
      }
    } else {
      console.warn('âš ï¸ No token found - registration may fail');
      // å¯é¸ï¼šé¡¯ç¤ºè­¦å‘Šçµ¦ç”¨æˆ¶
      // this.errorMessage = 'ç¼ºå°‘é©—è­‰ tokenï¼Œè«‹ç¢ºèªå¾æ­£ç¢ºçš„å¹³å°é€²å…¥';
    }
  }

  /**
   * ç•¶å¹´ä»½æˆ–æœˆä»½æ”¹è®Šæ™‚ï¼Œå‹•æ…‹èª¿æ•´æ—¥æœŸé¸é …
   */
  onDateChange(): void {
    const birthDateGroup = this.registerForm.get('birthDate');
    const year = birthDateGroup?.get('year')?.value;
    const month = birthDateGroup?.get('month')?.value;

    if (year && month) {
      const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
      this.days = [];
      for (let day = 1; day <= daysInMonth; day++) {
        this.days.push(day.toString().padStart(2, '0'));
      }

      const currentDay = birthDateGroup?.get('day')?.value;
      if (currentDay && parseInt(currentDay) > daysInMonth) {
        birthDateGroup?.get('day')?.setValue('');
      }
    }
  }

  /**
   * é€²å…¥ä¸‹ä¸€æ­¥é©Ÿ - ç™¼é€ OTP
   */
  nextStep(): void {
    this.isFormSubmitted = true;

    if (this.registerForm.valid) {
      this.openPhoneConfirmDialog();
    } else {
      this.markFormGroupTouched(this.registerForm);
    }
  }

  /**
   * é–‹å•Ÿæ‰‹æ©Ÿè™Ÿç¢¼ç¢ºèªå°è©±æ¡†
   */
  private openPhoneConfirmDialog(): void {
    const phoneNumber = this.registerForm.get('phoneNumber')?.value;

    const dialogRef = this.dialog.open(PhoneConfirmDialogComponent, {
      width: '400px',
      disableClose: true,
      data: { phoneNumber }
    });

    dialogRef.afterClosed().subscribe(result => {
      if (result === true) {
        this.proceedWithRegistration();
      }
    });
  }

  /**
   * ç¹¼çºŒé€²è¡Œè¨»å†Šæµç¨‹
   */
  private proceedWithRegistration(): void {
    this.isLoading = true;
    this.errorMessage = '';

    const formData: RegisterFormData = this.registerForm.value;

    this.registerService.sendRegistrationData(formData)
      .pipe(takeUntil(this.destroy$))
      .subscribe({
        next: (response) => {
          this.isLoading = false;
          if (response.success && response.data) {
            this.currentStep = 2;
            this.successMessage = response.message;
            this.startOtpCountdown(response.data.countdown);
          }
        },
        error: (error) => {
          this.isLoading = false;
          this.errorMessage = error.message || 'ç™¼é€é©—è­‰ç¢¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        }
      });
  }

  /**
   * å›åˆ°ä¸Šä¸€æ­¥é©Ÿ
   */
  previousStep(): void {
    this.currentStep = 1;
    this.clearMessages();
    this.clearCountdownTimer();
  }

  /**
   * å®Œæˆè¨»å†Š - é©—è­‰ OTP
   */
  completeRegistration(): void {
    if (this.otpForm.valid && this.registerForm.valid) {
      this.isLoading = true;
      this.errorMessage = '';

      const otpData: OtpVerifyData = {
        otpCode: this.otpForm.get('otpCode')?.value,
        phoneNumber: this.registerForm.get('phoneNumber')?.value
      };

      const formData: RegisterFormData = this.registerForm.value;

      this.registerService.verifyOtpAndRegister(otpData, formData)
        .pipe(takeUntil(this.destroy$))
        .subscribe({
          next: (response) => {
            this.isLoading = false;
            if (response.success && response.data) {
              this.successMessage = response.message;

              setTimeout(() => {
              // å„ªå…ˆä½¿ç”¨ token ä¸­çš„ redirectUrlï¼Œå…¶æ¬¡æ˜¯ API å›æ‡‰ä¸­çš„ redirectUrl
              const redirectUrl = this.tokenService.getRedirectUrlFromToken() 
                                 || response.data?.redirectUrl 
                               || '/success';
              
                console.log('ğŸ”„ Redirecting to:', redirectUrl);
              this.router.navigate([redirectUrl]);
            }, 2000);
            }
          },
          error: (error) => {
            this.isLoading = false;
            this.errorMessage = error.message || 'é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°è¼¸å…¥é©—è­‰ç¢¼';
          }
        });
    } else {
      this.markFormGroupTouched(this.otpForm);
    }
  }

  /**
   * é‡æ–°ç™¼é€ OTP
   */
  resendOtp(): void {
    if (!this.canResendOtp) return;

    this.isLoading = true;
    const phoneNumber = this.registerForm.get('phoneNumber')?.value;

    this.registerService.resendOtp(phoneNumber)
      .pipe(takeUntil(this.destroy$))
      .subscribe({
        next: (response) => {
          this.isLoading = false;
          if (response.success && response.data) {
            this.successMessage = response.message;
            this.startOtpCountdown(response.data.countdown);
            this.otpForm.get('otpCode')?.setValue('');
          }
        },
        error: (error) => {
          this.isLoading = false;
          this.errorMessage = error.message || 'é‡æ–°ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        }
      });
  }

  /**
   * é–‹å§‹ OTP å€’æ•¸è¨ˆæ™‚
   */
  private startOtpCountdown(seconds: number): void {
    this.otpCountdown = 300;
    this.canResendOtp = false;
    this.clearCountdownTimer();

    this.countdownTimer = window.setInterval(() => {
      this.otpCountdown--;

      if (this.otpCountdown <= 0) {
        this.canResendOtp = true;
        this.clearCountdownTimer();
      }
    }, 1000);
  }

  /**
   * æ¸…é™¤å€’æ•¸è¨ˆæ™‚å™¨
   */
  private clearCountdownTimer(): void {
    if (this.countdownTimer) {
      clearInterval(this.countdownTimer);
      this.countdownTimer = undefined;
    }
  }

  /**
   * æ¨™è¨˜è¡¨å–®ç¾¤çµ„ç‚ºå·²è§¸ç¢°ï¼Œä»¥é¡¯ç¤ºé©—è­‰éŒ¯èª¤
   */
  private markFormGroupTouched(formGroup: FormGroup): void {
    Object.keys(formGroup.controls).forEach(key => {
      const control = formGroup.get(key);
      control?.markAsTouched();

      if (control instanceof FormGroup) {
        this.markFormGroupTouched(control);
      }
    });
  }

  /**
   * æ¸…é™¤è¨Šæ¯
   */
  private clearMessages(): void {
    this.errorMessage = '';
    this.successMessage = '';
  }

  /**
   * å–å¾—è¡¨å–®æ§åˆ¶é …çš„éŒ¯èª¤è¨Šæ¯
   */
  getErrorMessage(controlName: string, formGroup: FormGroup = this.registerForm): string {
    const control = formGroup.get(controlName);

    if (control && control.invalid && control.touched) {
      const errors = control.errors;

      if (errors?.['required']) {
        return this.getRequiredMessage(controlName);
      }

      if (errors?.['email']) {
        return 'é›»å­ä¿¡ç®±æ ¼å¼ä¸æ­£ç¢º';
      }

      if (errors?.['minlength']) {
        return `æœ€å°‘éœ€è¦ ${errors['minlength'].requiredLength} å€‹å­—å…ƒ`;
      }

      if (errors?.['maxlength']) {
        return `æœ€å¤šåªèƒ½ ${errors['maxlength'].requiredLength} å€‹å­—å…ƒ`;
      }

      if (errors?.['taiwanId']) {
        return errors['taiwanId'].message;
      }

      if (errors?.['taiwanPhone']) {
        return errors['taiwanPhone'].message;
      }

      if (errors?.['minimumAge']) {
        return errors['minimumAge'].message;
      }

      if (errors?.['otpCode']) {
        return errors['otpCode'].message;
      }
    }

    return '';
  }

  /**
   * å–å¾—å¿…å¡«æ¬„ä½çš„éŒ¯èª¤è¨Šæ¯
   */
  private getRequiredMessage(controlName: string): string {
    const messages: { [key: string]: string } = {
      'idNumber': 'èº«åˆ†è­‰å­—è™Ÿç‚ºå¿…å¡«é …ç›®',
      'name': 'å§“åç‚ºå¿…å¡«é …ç›®',
      'birthDate.year': 'å‡ºç”Ÿå¹´ä»½ç‚ºå¿…å¡«é …ç›®',
      'birthDate.month': 'å‡ºç”Ÿæœˆä»½ç‚ºå¿…å¡«é …ç›®',
      'birthDate.day': 'å‡ºç”Ÿæ—¥æœŸç‚ºå¿…å¡«é …ç›®',
      'address.city': 'ç¸£å¸‚ç‚ºå¿…å¡«é …ç›®',
      'address.district': 'é„‰é®å¸‚å€ç‚ºå¿…å¡«é …ç›®',
      'address.detail': 'è©³ç´°åœ°å€ç‚ºå¿…å¡«é …ç›®',
      'phoneNumber': 'æ‰‹æ©Ÿè™Ÿç¢¼ç‚ºå¿…å¡«é …ç›®',
      'email': 'é›»å­ä¿¡ç®±ç‚ºå¿…å¡«é …ç›®',
      'otpCode': 'é©—è­‰ç¢¼ç‚ºå¿…å¡«é …ç›®'
    };

    return messages[controlName] || 'æ­¤æ¬„ä½ç‚ºå¿…å¡«é …ç›®';
  }

  /**
   * æª¢æŸ¥è¡¨å–®æ§åˆ¶é …æ˜¯å¦æœ‰éŒ¯èª¤ä¸”å·²è¢«è§¸ç¢°
   */
  hasError(controlName: string, formGroup: FormGroup = this.registerForm): boolean {
    const control = formGroup.get(controlName);
    return !!(control && control.invalid && (control.touched || this.isFormSubmitted));
  }

  /**
   * æ ¼å¼åŒ–å€’æ•¸è¨ˆæ™‚é¡¯ç¤º
   */
  formatCountdown(seconds: number): string {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
  }

  /**
   * å›åˆ°ä¸Šä¸€é  - ä½¿ç”¨ç€è¦½å™¨æ­·å²è¨˜éŒ„
   */
  goBack(): void {
    if (window.history.length > 1) {
      window.history.back();
    } else {
      this.router.navigate(['/']);
    }
  }

  /**
   * è¼‰å…¥ç¸£å¸‚åˆ—è¡¨
   */
  private loadCities(): void {
    this.isLoadingCities = true;
    
    // æ§åˆ¶ç¸£å¸‚ select çš„ç‹€æ…‹
    if (this.isLoadingCities) {
      this.registerForm.get('address.city')?.disable();
    }

    this.registerService.getCities()
      .pipe(takeUntil(this.destroy$))
      .subscribe({
        next: (response) => {
          this.isLoadingCities = false;
          this.registerForm.get('address.city')?.enable();
          
          if (response.success && response.data) {
            this.cities = response.data;
          } else {
            console.error('è¼‰å…¥ç¸£å¸‚å¤±æ•—:', response.message);
            this.cities = ['å°åŒ—å¸‚', 'æ–°åŒ—å¸‚'];
          }
        },
        error: (error) => {
          this.isLoadingCities = false;
          this.registerForm.get('address.city')?.enable();
          console.error('è¼‰å…¥ç¸£å¸‚ç™¼ç”ŸéŒ¯èª¤:', error);
          this.cities = ['å°åŒ—å¸‚', 'æ–°åŒ—å¸‚', 'æ¡ƒåœ’å¸‚', 'å°ä¸­å¸‚', 'å°å—å¸‚', 'é«˜é›„å¸‚'];
        }
      });
  }

  /**
   * ç•¶åŸå¸‚æ”¹è®Šæ™‚ï¼Œè¼‰å…¥å°æ‡‰çš„å€åŸŸé¸é …
   */
  onCityChange(): void {
    const city = this.registerForm.get('address.city')?.value;

    if (city) {
      this.registerForm.get('address.district')?.setValue('');
      this.currentDistricts = [];
      this.loadDistricts(city);
    } else {
      this.currentDistricts = [];
      this.registerForm.get('address.district')?.setValue('');
    }
  }

  /**
   * è¼‰å…¥æŒ‡å®šç¸£å¸‚çš„å€åŸŸåˆ—è¡¨
   */
  private loadDistricts(cityName: string): void {
    this.isLoadingDistricts = true;
    
    // æ§åˆ¶å€åŸŸ select çš„ç‹€æ…‹
    if (this.isLoadingDistricts) {
      this.registerForm.get('address.district')?.disable();
    }

    this.registerService.getDistricts(cityName)
      .pipe(takeUntil(this.destroy$))
      .subscribe({
        next: (response) => {
          this.isLoadingDistricts = false;
          this.registerForm.get('address.district')?.enable();
          
          if (response.success && response.data) {
            this.currentDistricts = response.data;
          } else {
            console.error('è¼‰å…¥å€åŸŸå¤±æ•—:', response.message);
            this.currentDistricts = [];
          }
        },
        error: (error) => {
          this.isLoadingDistricts = false;
          this.registerForm.get('address.district')?.enable();
          console.error('è¼‰å…¥å€åŸŸç™¼ç”ŸéŒ¯èª¤:', error);
          this.currentDistricts = [];
        }
      });
  }

  /**
   * å–å¾—ç›®å‰é¸æ“‡åŸå¸‚çš„å€åŸŸåˆ—è¡¨
   */
  getCurrentDistricts(): string[] {
    return ['æ¸¬è©¦å€1', 'æ¸¬è©¦å€2', 'æ¸¬è©¦å€3']; // é€™è£¡å¯ä»¥æ›¿æ›æˆå¯¦éš›çš„å€åŸŸåˆ—è¡¨
  }
}